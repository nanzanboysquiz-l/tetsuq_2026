<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Score Proto v29</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }

    /* 画面幅いっぱいの黒背景スクロール帯 */
    #topScroll {
      background: black;
      color: white;
      height: 24px;
      overflow-x: auto;
      white-space: nowrap;
      padding: 4px 8px;
      width: calc(100% - 40px); /* 左右余白20px×2 */
      margin-bottom: 6px;
    }

    /* 画面幅いっぱいの黒背景文字列窓 */
    #messageWindow {
      background: black;
      color: white;
      height: 32px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      width: calc(100% - 40px);
      margin-bottom: 10px;
    }

    /* プレイヤー一覧（横並び） */
    #players {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* プレイヤーカード：幅固定（10人並ぶ）、高さ固定 */
    .player {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      background: #fafafa;
      width: 9vw;
      height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .player.out { opacity: 0.4; background: #eee; }

    /* 名前欄（縦書き・中央寄せ・折り返し禁止・高さ固定） */
    .player-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-weight: 900;
      line-height: 1.1;
      height: 180px;
      width: 40px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      transform-origin: center center;
    }

    /* 状態表示（固定高さ） */
    .player-status {
      font-size: 18px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 得点表示（合計 - 誤答数） */
    .player-scoreline {
      font-size: 28px;
      font-weight: bold;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .player-score-total { color: red; }
    .player-score-dash  { color: black; }
    .player-score-wrong { color: blue; }

    /* ボタン（横並び・固定高さ） */
    .player-buttons {
      display: flex;
      flex-direction: row;
      gap: 8px;
      height: 40px;
      align-items: center;
      justify-content: center;
    }
    .score-btn {
      font-size: 20px;
      padding: 4px 10px;
    }

    /* ログ */
    #log {
      margin-top: 20px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 6px;
      background: #fdfdfd;
    }
    .log-item {
      padding: 4px 6px;
      margin-bottom: 4px;
      background: #f3f3f3;
      border-left: 4px solid #888;
      border-radius: 4px;
    }

    /* ゲージ全体 */
    #gaugeWrapper {
      position: relative;
      width: 100%;
      margin-top: 120px;
      margin-bottom: 20px;
    }

    #gaugeContainer {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      position: relative;
    }

    #gaugeBar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      border-radius: 10px;
      transition: width 0.3s;
    }

    .gaugeTick {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 28px;
      background: #333;
      border-radius: 2px;
    }

    #gaugeIcon {
      position: absolute;
      top: -110px;
      width: 98px;
      height: auto;
      transition: transform 0.3s;
      pointer-events: none;
      display: none;
    }
  </style>
</head>
<body>

<h2>Score Proto v26</h2>

<!-- ▼▼▼ 上部 UI（問題数より上） ▼▼▼ -->

<div id="topScroll">ここに問題文が表示されます</div>

<div id="messageWindow">ここに解答が表示されます</div>

<div style="margin-bottom: 20px;">
  <input type="file" id="csvInput" accept=".csv">
  <button onclick="loadCSV()">CSV読み込み</button>
</div>

<!-- ▲▲▲ 上部 UI ここまで ▲▲▲ -->

<h3 id="problemCountDisplay">問題数: 0</h3>

<div>
  <input id="maxProblems" type="number" placeholder="限定問題数" style="width:120px">
  <button onclick="setMaxProblems()">設定</button>
</div>

<div id="gaugeWrapper">
  <img id="gaugeIcon" src="assets/images/tokuten/kyot10l.png">
  <div id="gaugeContainer">
    <div id="gaugeBar"></div>
  </div>
</div>

<div>
  <select id="presetSelect">
    <option value="">ルールプリセットを選択</option>
    <option value="nmarubatsu">n○m×</option>
    <option value="updown">Up-Down</option>
    <option value="freeze">Freeze</option>
  </select>
  <button onclick="applyPreset()">適用</button>
</div>

<div>
  <input id="playerName" placeholder="プレイヤー名">
  <button onclick="addPlayer()">追加</button>
</div>

<div>
  <button onclick="noAnswer()">スルー（無回答）</button>
  <button onclick="undo()">Undo</button>
</div>

<hr>

<div id="players"></div>

<h3>Log</h3>
<div id="log"></div>

<!-- ▼▼▼ v29 SCRIPT PART 1/2 : LINES 1–300 ▼▼▼ -->

<script>
/* ============================
   v29 JavaScript — PART 1/2
   Lines 1–300
============================ */

/* --- 基本データ --- */
let players = [];
let scoreItems = [];
let history = [];
let logs = [];
let problemCount = 0;
let maxProblems = null;
let finished = false;

let questionData = []; // CSV の問題データ

/* --- 限定問題数設定 --- */
function setMaxProblems() {
  const input = document.getElementById("maxProblemsInput").value.trim();
  if (!input) {
    maxProblems = null;
    updateGauge();
    return;
  }

  const n = Number(input);
  if (!Number.isFinite(n) || n <= 0) {
    alert("正しい問題数を入力してください");
    return;
  }

  maxProblems = n;
  updateGauge();
}

/* --- ゲージの目盛り描画 --- */
function drawGaugeTicks() {
  const container = document.getElementById("gaugeContainer");
  const tickLayer = document.getElementById("gaugeTicks");
  tickLayer.innerHTML = "";

  if (!maxProblems) return;

  const total = maxProblems;
  const width = container.offsetWidth;

  for (let i = 1; i < total; i++) {
    const tick = document.createElement("div");
    tick.className = "gauge-tick";
    const x = (i / total) * width;
    tick.style.left = `${x}px`;
    tickLayer.appendChild(tick);
  }
}

/* --- ゲージ更新 --- */
function updateGauge() {
  if (!maxProblems) return;

  const ratio = Math.min(problemCount / maxProblems, 1);
  const bar = document.getElementById("gaugeBar");
  bar.style.width = (ratio * 100) + "%";

  const icon = document.getElementById("gaugeIcon");
  const containerWidth = document.getElementById("gaugeContainer").offsetWidth;
  const iconWidth = icon.offsetWidth;

  if (problemCount === 0) {
    icon.style.display = "none";
    return;
  } else {
    icon.style.display = "block";
  }

  const x = ratio * containerWidth - iconWidth;
  icon.style.transform = `translateX(${x}px)`;
}

/* --- プリセット適用 --- */
function applyPreset() {
  const preset = document.getElementById("presetSelect").value;

  if (preset === "nmarubatsu") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: -1 }
    ];
  }

  if (preset === "updown") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: -1 }
    ];
  }

  if (preset === "freeze") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: 0 }
    ];
  }

  renderScoreItems();
}

/* --- スコア項目の描画 --- */
function renderScoreItems() {
  const area = document.getElementById("scoreItemArea");
  area.innerHTML = "";

  scoreItems.forEach(item => {
    const div = document.createElement("div");
    div.className = "score-item";
    div.textContent = `${item.name}（重み ${item.weight}）`;
    area.appendChild(div);
  });
}

/* --- プレイヤー追加 --- */
function addPlayer() {
  const name = document.getElementById("playerNameInput").value.trim();
  if (!name) return;

  const p = {
    name,
    scores: {},
    status: "in",
    freezeStop: 0
  };

  scoreItems.forEach(item => {
    p.scores[item.name] = 0;
  });

  players.push(p);
  document.getElementById("playerNameInput").value = "";
  render();
}

/* --- スコア変更 --- */
function changeScore(index, itemName, delta) {
  const p = players[index];
  if (!p) return;

  const prevScores = structuredClone(p.scores);
  const prevStatus = p.status;
  const prevFreeze = p.freezeStop;

  history.push({
    type: "score",
    playerIndex: index,
    itemName,
    prevScores,
    prevStatus,
    prevFreeze,
    problemDelta: 0
  });

  p.scores[itemName] += delta;

  if (itemName === "誤答") {
    if (document.getElementById("presetSelect").value === "freeze") {
      p.freezeStop = 2;
    }
  }

  logs.push(`${new Date().toLocaleTimeString()} ${p.name} ${itemName} ${delta > 0 ? "+" : ""}${delta}`);

  render();
}

/* --- スルー処理 --- */
function noAnswer() {
  const prevFreeze = players.map(p => p.freezeStop);

  history.push({
    type: "noAnswer",
    prevFreeze,
    problemDelta: +1
  });

  problemCount++;
  updateQuestionDisplay();
  updateGauge();

  logs.push(`${new Date().toLocaleTimeString()} スルー`);
  render();
}

/* --- CSV 読み込み --- */
function loadCSV() {
  const input = document.getElementById("csvInput");
  if (!input.files.length) return;

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/);

    questionData = [];

    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cols = lines[i].split(",");

      questionData.push({
        number: cols[0],
        question: cols[1],
        answer: cols[2]
      });
    }

    updateQuestionDisplay();
  };

  reader.readAsText(file, "UTF-8");
}

/* --- 問題番号に応じて表示更新 --- */
function updateQuestionDisplay() {
  const num = problemCount;

  const item = questionData.find(q => q.number == num);

  if (!item) {
    document.getElementById("topScroll").textContent = "ここに問題文が表示されます";
    document.getElementById("messageWindow").textContent = "ここに解答が表示されます";
    return;
  }

  document.getElementById("topScroll").textContent = item.question;
  document.getElementById("messageWindow").textContent = item.answer;
}

/* --- Freeze 減衰 --- */
function applyFreezeDecay() {
  if (getPreset() !== "freeze") return;

  players.forEach(p => {
    if (p.freezeStop > 0) p.freezeStop--;
  });
}

/* --- 終了判定 --- */
function checkFinish() {
  if (maxProblems && problemCount >= maxProblems) {
    finished = true;
    logs.push(`${new Date().toLocaleTimeString()} ★終了★`);
  }
}

/* --- Undo --- */
function undo() {
  const last = history.pop();
  if (!last) return;

  if (last.type === "score") {
    const p = players[last.playerIndex];
    p.scores = last.prevScores;
    p.status = last.prevStatus;
    p.freezeStop = last.prevFreeze;

    logs.push(`${new Date().toLocaleTimeString()} Undo: ${p.name} ${last.itemName}`);
  }

  if (last.type === "noAnswer") {
    logs.push(`${new Date().toLocaleTimeString()} Undo: スルー取消`);
    players.forEach((p, i) => {
      p.freezeStop = last.prevFreeze[i];
    });
  }

  if (last.problemDelta) {
    problemCount += last.problemDelta;
  }

  finished = false;
  updateQuestionDisplay();
  updateGauge();
  render();
}

/* --- 合計得点計算 --- */
function calcTotal(player) {
  let total = 0;
  scoreItems.forEach(item => {
    const v = player.scores[item.name];
    const safe = Number.isFinite(v) ? v : 0;
    total += safe * item.weight;
  });
  return total;
}

/* --- ログ描画 --- */
function renderLog() {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML = "";

  logs.slice(-200).forEach(line => {
    const div = document.createElement("div");
    div.className = "log-item";
    div.textContent = line;
    logDiv.appendChild(div);
  });
}

/* --- プレイヤー描画 --- */
function render() {
  const area = document.getElementById("playerArea");
  area.innerHTML = "";

  players.forEach((p, index) => {
    const card = document.createElement("div");
    card.className = "player-card";

    if (p.status === "out") {
      card.classList.add("player-out");
    }

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.textContent = p.name;
    card.appendChild(nameDiv);

    const scoreDiv = document.createElement("div");
    scoreDiv.className = "player-score";
    scoreDiv.textContent = calcTotal(p);
    card.appendChild(scoreDiv);

    const btnArea = document.createElement("div");
    btnArea.className = "player-buttons";

    scoreItems.forEach(item => {
      const btn = document.createElement("button");
      btn.className = "score-btn";
      btn.textContent = item.name;
      btn.onclick = () => changeScore(index, item.name, +1);
      btnArea.appendChild(btn);
    });

    const wrongBtn = document.createElement("button");
    wrongBtn.className = "score-btn";
    wrongBtn.textContent = "誤答";
    wrongBtn.onclick = () => changeScore(index, "誤答", +1);
    btnArea.appendChild(wrongBtn);

    card.appendChild(btnArea);
    area.appendChild(card);
  });

  renderLog();
}

/* --- ショートカットキー操作 --- */
document.addEventListener("keydown", (e) => {
  if (finished) return;

  const key = e.key;

  /* ○（正解）: 1〜9 → 1〜9人目、0 → 10人目 */
  if (!e.shiftKey) {
    let index = null;

    if (key >= "1" && key <= "9") index = parseInt(key) - 1;
    else if (key === "0") index = 9;

    if (index !== null && index < players.length) {
      const p = players[index];
      if (p.status !== "out" && p.freezeStop === 0) {
        changeScore(index, "正解", +1);
      }
    }
  }

  /* ×（誤答）: Shift + 数字 */
  if (e.shiftKey) {
    let index = null;

    if (key >= "1" && key <= "9") index = parseInt(key) - 1;
    else if (key === "0") index = 9;

    if (index !== null && index < players.length) {
      const p = players[index];
      if (p.status !== "out" && p.freezeStop === 0) {
        changeScore(index, "誤答", +1);
      }
    }
  }

  /* Insert → スルー */
  if (key === "Insert") {
    noAnswer();
  }

  /* Delete → Undo */
  if (key === "Delete") {
    undo();
  }
});

</script>
</body>
</html>
