<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Score Proto v16</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }

    /* プレイヤー表示（横固定） */
    #players {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
    }

    .player {
      border: 1px solid #ccc;
      padding: 15px;
      border-radius: 10px;
      background: #fafafa;
      width: 260px;
      height: 260px;
      display: flex;
      flex-direction: row;
      gap: 10px;
    }
    .player.out { opacity: 0.4; background: #eee; }

    /* 左側：縦書きプレイヤー名 */
    .player-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-size: 36px;
      font-weight: 900;
      line-height: 1.1;
      border-right: 2px solid #ccc;
      padding-right: 10px;
      height: 100%;
      display: flex;
      align-items: flex-start;
    }

    /* 右側：スコア・状態・ボタン */
    .player-right {
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      width: 100%;
    }

    /* 状態表示欄（Stopなど） */
    .player-status {
      height: 28px;
      font-size: 20px;
      color: #333;
      margin-bottom: 6px;
    }

    /* 合計（数字のみ・大きく赤） */
    .player-total {
      font-size: 36px;
      color: red;
      font-weight: bold;
      margin-bottom: 10px;
    }

    /* ボタン縦並び */
    .score-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .score-btn {
      font-size: 22px;
      padding: 6px 10px;
    }

    /* ログ */
    #log {
      margin-top: 20px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 6px;
      background: #fdfdfd;
    }
    .log-item {
      padding: 4px 6px;
      margin-bottom: 4px;
      background: #f3f3f3;
      border-left: 4px solid #888;
      border-radius: 4px;
    }

    /* ゲージ全体（画像の高さを考慮して下げる） */
    #gaugeWrapper {
      position: relative;
      width: 100%;
      margin-top: 120px;
      margin-bottom: 20px;
    }

    #gaugeContainer {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      position: relative;
    }

    #gaugeBar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      border-radius: 10px;
      transition: width 0.3s;
    }

    /* 節（5問ごと） */
    .gaugeTick {
      position: absolute;
      top: -4px;
      width: 4px;
      height: 28px;
      background: #333;
      border-radius: 2px;
    }

    /* 画像（ゲージ上を移動） */
    #gaugeIcon {
      position: absolute;
      top: -110px;
      width: 98px;
      height: auto;
      transition: transform 0.3s;
      pointer-events: none;
      display: none;
    }
  </style>
</head>
<body>

<h2>Score Proto v16</h2>

<h3 id="problemCountDisplay">問題数: 0</h3>

<!-- 限定問題数 -->
<div>
  <input id="maxProblems" type="number" placeholder="限定問題数" style="width:120px">
  <button onclick="setMaxProblems()">設定</button>
</div>

<!-- ゲージ（節 + 画像） -->
<div id="gaugeWrapper">
  <img id="gaugeIcon" src="assets/images/tokuten/kyot10l.png">
  <div id="gaugeContainer">
    <div id="gaugeBar"></div>
  </div>
</div>

<!-- ルールプリセット -->
<div>
  <select id="presetSelect">
    <option value="">ルールプリセットを選択</option>
    <option value="nmarubatsu">n○m×</option>
    <option value="updown">Up-Down</option>
    <option value="freeze">Freeze</option>
  </select>
  <button onclick="applyPreset()">適用</button>
</div>

<!-- プレイヤー追加 -->
<div>
  <input id="playerName" placeholder="プレイヤー名">
  <button onclick="addPlayer()">追加</button>
</div>

<!-- 問題数操作 -->
<div>
  <button onclick="noAnswer()">スルー（無回答）</button>
  <button onclick="undo()">Undo</button>
</div>

<hr>

<div id="players"></div>

<h3>Log</h3>
<div id="log"></div>

<script>
  let players = [];
  let scoreItems = [];
  let history = [];
  let logs = [];
  let problemCount = 0;
  let maxProblems = null;
  let finished = false;

  const presets = {
    nmarubatsu: {
      items: [
        { name: "正解", weight: 1, label: "○" },
        { name: "誤答", weight: 1, label: "×" },
        { name: "アドバンテージ", weight: 1, label: null }
      ]
    },
    updown: {
      items: [
        { name: "正解", weight: 1, label: "○" },
        { name: "誤答", weight: 1, label: "×" }
      ]
    },
    freeze: {
      items: [
        { name: "正解", weight: 1, label: "○" },
        { name: "誤答", weight: 1, label: "×" }
      ]
    }
  };

  function getPreset() {
    return document.getElementById("presetSelect").value;
  }

  /* 限定問題数設定 */
  function setMaxProblems() {
    maxProblems = parseInt(document.getElementById("maxProblems").value);
    drawGaugeTicks();
    updateGauge();
  }

  /* 節を描画（5問ごと） */
  function drawGaugeTicks() {
    const container = document.getElementById("gaugeContainer");
    container.querySelectorAll(".gaugeTick").forEach(e => e.remove());

    if (!maxProblems) return;

    for (let i = 5; i <= maxProblems; i += 5) {
      const tick = document.createElement("div");
      tick.className = "gaugeTick";
      const ratio = i / maxProblems;
      tick.style.left = `calc(${ratio * 100}% - 2px)`;
      container.appendChild(tick);
    }
  }

  /* ゲージ更新 + 画像移動（右端合わせ） */
  function updateGauge() {
    if (!maxProblems) return;

    const ratio = Math.min(problemCount / maxProblems, 1);
    const bar = document.getElementById("gaugeBar");
    bar.style.width = (ratio * 100) + "%";

    const icon = document.getElementById("gaugeIcon");
    const containerWidth = document.getElementById("gaugeContainer").offsetWidth;
    const iconWidth = icon.offsetWidth;

    if (problemCount === 0) {
      icon.style.display = "none";
      return;
    } else {
      icon.style.display = "block";
    }

    const x = ratio * containerWidth - iconWidth;
    icon.style.transform = `translateX(${x}px)`;
  }

  function applyPreset() {
    const key = getPreset();
    if (!key) return;

    scoreItems = JSON.parse(JSON.stringify(presets[key].items));
    render();
  }

  function render() {
    const container = document.getElementById("players");
    container.innerHTML = "";

    players.forEach((p, idx) => {
      const div = document.createElement("div");
      div.className = "player";
      if (p.status === "out") div.classList.add("out");

      /* 左側：縦書きプレイヤー名 */
      const nameDiv = document.createElement("div");
      nameDiv.className = "player-name";
      nameDiv.textContent = p.name;
      div.appendChild(nameDiv);

      /* 右側：状態・合計・ボタン */
      const right = document.createElement("div");
      right.className = "player-right";

      /* 状態表示欄 */
      const statusDiv = document.createElement("div");
      statusDiv.className = "player-status";

      if (getPreset() === "freeze" && p.freezeStop > 0) {
        statusDiv.textContent = `Stop ${p.freezeStop}`;
      } else if (p.status === "out") {
        statusDiv.textContent = "脱落";
      } else {
        statusDiv.textContent = "";
      }

      right.appendChild(statusDiv);

      /* 合計（数字のみ） */
      const totalDiv = document.createElement("div");
      totalDiv.className = "player-total";
      totalDiv.textContent = calcTotal(p);
      right.appendChild(totalDiv);

      /* ボタン縦並び */
      scoreItems.forEach(item => {
        if (!(item.name in p.scores)) p.scores[item.name] = 0;

        const row = document.createElement("div");
        row.className = "score-item";

        const plus = document.createElement("button");
        plus.className = "score-btn";
        plus.textContent = item.label || "+1";

        if (p.freezeStop > 0) plus.style.display = "none";
        plus.disabled = p.status === "out" || finished;

        plus.onclick = () => changeScore(idx, item.name, +1);
        row.appendChild(plus);

        right.appendChild(row);
      });

      div.appendChild(right);
      container.appendChild(div);
    });

    document.getElementById("problemCountDisplay").textContent =
      `問題数: ${problemCount}`;

    renderLog();
  }

  function addPlayer() {
    const name = document.getElementById("playerName").value;
    if (!name) return;
    players.push({ name, scores: {}, status: "alive", freezeStop: 0 });
    document.getElementById("playerName").value = "";
    render();
  }

  function changeScore(playerIndex, itemName, delta) {
    if (finished) return;

    const p = players[playerIndex];
    const preset = getPreset();

    history.push({
      type: "score",
      playerIndex,
      itemName,
      delta: -delta,
      problemDelta: -1,
      prevStatus: p.status,
      prevScores: JSON.parse(JSON.stringify(p.scores)),
      prevFreeze: p.freezeStop
    });

    logs.push(`${new Date().toLocaleTimeString()} ${p.name} ${itemName} +1`);

    p.scores[itemName] += delta;

    /* Up-Down */
    if (preset === "updown" && itemName === "誤答") {
      if (p.scores["誤答"] === 1) p.scores["正解"] = 0;
      if (p.scores["誤答"] === 2) p.status = "out";
    }

    /* Freeze */
    if (preset === "freeze" && itemName === "誤答") {
      p.freezeStop = p.scores["誤答"];
    }

    problemCount++;
    applyFreezeDecay();
    updateGauge();
    checkFinish();
    render();
  }

  function noAnswer() {
    if (finished) return;

    history.push({
      type: "noAnswer",
      problemDelta: -1,
      prevFreeze: players.map(p => p.freezeStop)
    });

    logs.push(`${new Date().toLocaleTimeString()} スルー（無回答）`);

    problemCount++;
    applyFreezeDecay();
    updateGauge();
    checkFinish();
    render();
  }

  function applyFreezeDecay() {
    if (getPreset() !== "freeze") return;

    players.forEach(p => {
      if (p.freezeStop > 0) p.freezeStop--;
    });
  }

  function checkFinish() {
    if (maxProblems && problemCount >= maxProblems) {
      finished = true;
      logs.push(`${new Date().toLocaleTimeString()} ★終了★`);
    }
  }

  function undo() {
    const last = history.pop();
    if (!last) return;

    if (last.type === "score") {
      const p = players[last.playerIndex];
      p.scores = last.prevScores;
      p.status = last.prevStatus;
      p.freezeStop = last.prevFreeze;

      logs.push(`${new Date().toLocaleTimeString()} Undo: ${p.name} ${last.itemName}`);
    }

    if (last.type === "noAnswer") {
      logs.push(`${new Date().toLocaleTimeString()} Undo: スルー取消`);
      players.forEach((p, i) => {
        p.freezeStop = last.prevFreeze[i];
      });
    }

    if (last.problemDelta) {
      problemCount += last.problemDelta;
    }

    finished = false;
    updateGauge();
    render();
  }

  function calcTotal(player) {
    let total = 0;
    scoreItems.forEach(item => {
      const v = player.scores[item.name] || 0;
      total += v * item.weight;
    });
    return total;
  }

  function renderLog() {
    const logDiv = document.getElementById("log");
    logDiv.innerHTML = "";

    logs.slice(-200).forEach(line => {
      const div = document.createElement("div");
      div.className = "log-item";
      div.textContent = line;
      logDiv.appendChild(div);
    });
  }
</script>

</body>
</html>
