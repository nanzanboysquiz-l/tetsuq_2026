<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Score Proto v31</title>

  <style>
    body { font-family: sans-serif; margin: 20px; }

    #topScroll {
      background: black;
      color: white;
      height: 24px;
      overflow-x: auto;
      white-space: nowrap;
      padding: 4px 8px;
      width: calc(100% - 40px);
      margin-bottom: 6px;
    }

    #messageWindow {
      background: black;
      color: white;
      height: 32px;
      padding: 6px 8px;
      display: flex;
      align-items: center;
      width: calc(100% - 40px);
      margin-bottom: 10px;
    }

    #players {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 10px;
    }

    .player-card {
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      background: #fafafa;
      width: 9vw;
      height: 300px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .player-out { opacity: 0.4; background: #eee; }

    .player-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-weight: 900;
      line-height: 1.1;
      height: 180px;
      width: 40px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
    }

    .player-score {
      font-size: 28px;
      font-weight: bold;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #log {
      margin-top: 20px;
      font-size: 14px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 6px;
      background: #fdfdfd;
    }
    .log-item {
      padding: 4px 6px;
      margin-bottom: 4px;
      background: #f3f3f3;
      border-left: 4px solid #888;
      border-radius: 4px;
    }

    #gaugeWrapper {
      position: relative;
      width: 100%;
      margin-top: 120px;
      margin-bottom: 20px;
    }

    #gaugeContainer {
      width: 100%;
      height: 20px;
      background: #ddd;
      border-radius: 10px;
      position: relative;
    }

    #gaugeBar {
      height: 100%;
      width: 0%;
      background: #4caf50;
      border-radius: 10px;
      transition: width 0.3s;
    }

    #gaugeIcon {
      position: absolute;
      top: -110px;
      width: 98px;
      height: auto;
      transition: transform 0.3s;
      pointer-events: none;
      display: none;
    }
  </style>
</head>

<body>

<h2>Score Proto v31</h2>

<div id="topScroll">ここに問題文が表示されます</div>
<div id="messageWindow">ここに解答が表示されます</div>

<div style="margin-bottom: 20px;">
  <input type="file" id="csvInput" accept=".csv">
  <button onclick="loadCSV()">CSV読み込み</button>
</div>

<h3 id="problemCountDisplay">問題数: 0</h3>

<div>
  <input id="maxProblems" type="number" placeholder="限定問題数" style="width:120px">
  <button onclick="setMaxProblems()">設定</button>
</div>

<div id="gaugeWrapper">
  <img id="gaugeIcon" src="assets/images/tokuten/kyot10l.png">
  <div id="gaugeContainer">
    <div id="gaugeBar"></div>
  </div>
</div>

<div>
  <select id="presetSelect">
    <option value="">ルールプリセットを選択</option>
    <option value="nmarubatsu">n○m×</option>
    <option value="updown">Up-Down</option>
    <option value="freeze">Freeze</option>
  </select>
  <button onclick="applyPreset()">適用</button>
</div>

<div>
  <input id="playerName" placeholder="プレイヤー名">
  <button onclick="addPlayer()">追加</button>
</div>

<div>
  <button onclick="noAnswer()">スルー（無回答）</button>
  <button onclick="undo()">Undo</button>
</div>

<hr>

<div id="players"></div>

<h3>Log</h3>
<div id="log"></div>

<script>
/* ============================
   v31 JavaScript
============================ */

let players = [];
let scoreItems = [];
let history = [];
let logs = [];
let problemCount = 0;
let maxProblems = null;
let finished = false;

let questionData = [];

/* 限定問題数設定 */
function setMaxProblems() {
  const input = document.getElementById("maxProblems").value.trim();
  if (!input) {
    maxProblems = null;
    updateGauge();
    return;
  }

  const n = Number(input);
  if (!Number.isFinite(n) || n <= 0) {
    alert("正しい問題数を入力してください");
    return;
  }

  maxProblems = n;
  updateGauge();
}

/* ゲージ更新 */
function updateGauge() {
  if (!maxProblems) return;

  const ratio = Math.min(problemCount / maxProblems, 1);
  const bar = document.getElementById("gaugeBar");
  bar.style.width = (ratio * 100) + "%";

  const icon = document.getElementById("gaugeIcon");
  const containerWidth = document.getElementById("gaugeContainer").offsetWidth;
  const iconWidth = icon.offsetWidth;

  if (problemCount === 0) {
    icon.style.display = "none";
    return;
  } else {
    icon.style.display = "block";
  }

  const x = ratio * containerWidth - iconWidth;
  icon.style.transform = `translateX(${x}px)`;
}

/* プリセット適用 */
function applyPreset() {
  const preset = document.getElementById("presetSelect").value;

  if (preset === "nmarubatsu") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: -1 }
    ];
  }

  if (preset === "updown") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: -1 }
    ];
  }

  if (preset === "freeze") {
    scoreItems = [
      { name: "正解", weight: +1 },
      { name: "誤答", weight: 0 }
    ];
  }

  render();
}

/* プレイヤー追加 */
function addPlayer() {
  const name = document.getElementById("playerName").value.trim();
  if (!name) return;

  const p = {
    name,
    scores: {},
    status: "in",
    freezeStop: 0
  };

  scoreItems.forEach(item => {
    p.scores[item.name] = 0;
  });

  players.push(p);
  document.getElementById("playerName").value = "";
  render();
}

/* スコア変更（キーボード専用） */
function changeScore(index, itemName, delta) {
  const p = players[index];
  if (!p) return;

  const prevScores = structuredClone(p.scores);
  const prevStatus = p.status;
  const prevFreeze = p.freezeStop;

  history.push({
    type: "score",
    playerIndex: index,
    itemName,
    prevScores,
    prevStatus,
    prevFreeze,
    problemDelta: 0
  });

  p.scores[itemName] += delta;

  if (itemName === "誤答" && document.getElementById("presetSelect").value === "freeze") {
    p.freezeStop = 2;
  }

  logs.push(`${new Date().toLocaleTimeString()} ${p.name} ${itemName} ${delta > 0 ? "+" : ""}${delta}`);

  render();
}

/* スルー */
function noAnswer() {
  const prevFreeze = players.map(p => p.freezeStop);

  history.push({
    type: "noAnswer",
    prevFreeze,
    problemDelta: +1
  });

  problemCount++;
  updateQuestionDisplay();
  updateGauge();

  logs.push(`${new Date().toLocaleTimeString()} スルー`);
  render();
}

/* CSV 読み込み */
function loadCSV() {
  const input = document.getElementById("csvInput");
  if (!input.files.length) return;

  const file = input.files[0];
  const reader = new FileReader();

  reader.onload = function(e) {
    const text = e.target.result;
    const lines = text.split(/\r?\n/);

    questionData = [];

    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cols = lines[i].split(",");

      questionData.push({
        number: cols[0],
        question: cols[1],
        answer: cols[2]
      });
    }

    updateQuestionDisplay();
  };

  reader.readAsText(file, "UTF-8");
}

/* 問題表示更新 */
function updateQuestionDisplay() {
  const num = problemCount;

  const item = questionData.find(q => q.number == num);

  if (!item) {
    document.getElementById("topScroll").textContent = "ここに問題文が表示されます";
    document.getElementById("messageWindow").textContent = "ここに解答が表示されます";
  } else {
    document.getElementById("topScroll").textContent = item.question;
    document.getElementById("messageWindow").textContent = item.answer;
  }

  document.getElementById("problemCountDisplay").textContent =
    `問題数: ${problemCount}`;
}

/* Freeze 減衰 */
function applyFreezeDecay() {
  if (document.getElementById("presetSelect").value !== "freeze") return;

  players.forEach(p => {
    if (p.freezeStop > 0) p.freezeStop--;
  });
}

/* 終了判定 */
function checkFinish() {
  if (maxProblems && problemCount >= maxProblems) {
    finished = true;
    logs.push(`${new Date().toLocaleTimeString()} ★終了★`);
  }
}

/* Undo */
function undo() {
  const last = history.pop();
  if (!last) return;

  if (last.type === "score") {
    const p = players[last.playerIndex];
    p.scores = last.prevScores;
    p.status = last.prevStatus;
    p.freezeStop = last.prevFreeze;

    logs.push(`${new Date().toLocaleTimeString()} Undo: ${p.name} ${last.itemName}`);
  }

  if (last.type === "noAnswer") {
    logs.push(`${new Date().toLocaleTimeString()} Undo: スルー取消`);
    players.forEach((p, i) => {
      p.freezeStop = last.prevFreeze[i];
    });
  }

  if (last.problemDelta) {
    problemCount += last.problemDelta;
  }

  finished = false;
  updateQuestionDisplay();
  updateGauge();
  render();
}

/* 合計得点 */
function calcTotal(player) {
  let total = 0;
  scoreItems.forEach(item => {
    const v = player.scores[item.name];
    const safe = Number.isFinite(v) ? v : 0;
    total += safe * item.weight;
  });
  return total;
}

/* ログ描画 */
function renderLog() {
  const logDiv = document.getElementById("log");
  logDiv.innerHTML = "";

  logs.slice(-200).forEach(line => {
    const div = document.createElement("div");
    div.className = "log-item";
    div.textContent = line;
    logDiv.appendChild(div);
  });
}

/* プレイヤー描画 */
function render() {
  const area = document.getElementById("players");
  area.innerHTML = "";

  players.forEach((p, index) => {
    const card = document.createElement("div");
    card.className = "player-card";

    if (p.status === "out") {
      card.classList.add("player-out");
    }

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.textContent = p.name;
    card.appendChild(nameDiv);

    const scoreDiv = document.createElement("div");
    scoreDiv.className = "player-score";

    const total = calcTotal(p);
    const wrong = p.scores["誤答"] ?? 0;
    scoreDiv.textContent = `${total} - ${wrong}`;

    card.appendChild(scoreDiv);

    area.appendChild(card);
  });

  renderLog();
}

/* キーボード操作（○×ボタン廃止） */
document.addEventListener("keydown", (e) => {
  if (finished) return;

  const key = e.key;

  /* 正解：数字キー（1〜9 → 1〜9人目、0 → 10人目） */
  if (!e.shiftKey) {
    let index = null;

    if (key >= "1" && key <= "9") index = parseInt(key) - 1;
    else if (key === "0") index = 9;

    if (index !== null && index < players.length) {
      const p = players[index];
      if (p.status !== "out" && p.freezeStop === 0) {
        changeScore(index, "正解", +1);
      }
    }
  }

  /* 誤答：Shift + 数字 */
  if (e.shiftKey) {
    let index = null;

    if (key >= "1" && key <= "9") index = parseInt(key) - 1;
    else if (key === "0") index = 9;

    if (index !== null && index < players.length) {
      const p = players[index];
      if (p.status !== "out" && p.freezeStop === 0) {
        changeScore(index, "誤答", +1);
      }
    }
  }

  /* Insert → スルー */
  if (key === "Insert") {
    noAnswer();
  }

  /* Delete → Undo */
  if (key === "Delete") {
    undo();
  }
});
</script>

</body>
</html>
