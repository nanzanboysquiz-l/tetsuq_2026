<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Settings v4</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }

    #log {
      margin-top: 20px;
      font-size: 14px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 6px;
      border-radius: 6px;
      background: #fdfdfd;
    }
    .log-item {
      padding: 4px 6px;
      margin-bottom: 4px;
      background: #f3f3f3;
      border-left: 4px solid #888;
      border-radius: 4px;
    }

    .block {
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
  </style>
</head>

<body>

<h2>設定画面（Settings v4）</h2>

<div style="margin-bottom:20px;">
  <a href="main.html">← メイン画面へ戻る</a>
</div>

<!-- 限定問題数 -->
<div class="block">
  <h3>限定問題数</h3>
  <input id="maxProblems" type="number" placeholder="限定問題数" style="width:120px">
  <button onclick="saveMaxProblems()">設定</button>
</div>

<!-- ルールプリセット -->
<div class="block">
  <h3>ルールプリセット</h3>
  <select id="presetSelect">
    <option value="">ルールプリセットを選択</option>
    <option value="nmarubatsu">n○m×</option>
    <option value="updown">Up-Down</option>
    <option value="freeze">Freeze</option>
  </select>
  <button onclick="applyPreset()">適用</button>
</div>

<!-- 勝ち抜け・脱落設定 -->
<div class="block">
  <h3>勝ち抜け・脱落設定</h3>

  <div>
    勝ち抜け点：
    <input id="winScore" type="number" style="width:80px">
  </div>

  <div>
    勝ち抜け人数：
    <input id="winCount" type="number" style="width:80px">
  </div>

  <div>
    脱落誤答数：
    <input id="loseWrong" type="number" style="width:80px">
  </div>

  <button onclick="saveWinLoseSettings()">保存</button>
</div>

<!-- プレイヤー編集（v4） -->
<div class="block">
  <h3>プレイヤー編集（順位,都道府県,名前）</h3>
  <textarea id="playerEditor" style="width:350px; height:200px;"></textarea>
  <br>
  <button onclick="savePlayers()">保存</button>
</div>

<!-- Log -->
<div class="block">
  <h3>Log</h3>
  <div id="log"></div>
</div>

<script>
  /* ====== localStorage 読み込み ====== */
  let players    = JSON.parse(localStorage.getItem("players") || "[]");
  let scoreItems = JSON.parse(localStorage.getItem("scoreItems") || "[]");
  let logs       = JSON.parse(localStorage.getItem("logs") || "[]");

  let winScore  = Number(localStorage.getItem("winScore")  || 0);
  let winCount  = Number(localStorage.getItem("winCount")  || 0);
  let loseWrong = Number(localStorage.getItem("loseWrong") || 0);

  /* ====== プリセット定義 ====== */
  const presets = {
    nmarubatsu: {
      items: [
        { name: "正解", weight: 1 },
        { name: "誤答", weight: 0 },
        { name: "アドバンテージ", weight: 1 }
      ],
      winScore: 5,
      winCount: 3,
      loseWrong: 3
    },
    updown: {
      items: [
        { name: "正解", weight: 1 },
        { name: "誤答", weight: 0 }
      ],
      winScore: 5,
      winCount: 2,
      loseWrong: 2
    },
    freeze: {
      items: [
        { name: "正解", weight: 1 },
        { name: "誤答", weight: 0 }
      ],
      winScore: 5,
      winCount: 3,
      loseWrong: 3
    }
  };

  /* ====== 限定問題数 ====== */
  function saveMaxProblems() {
    const v = Number(document.getElementById("maxProblems").value);
    if (!v || v <= 0) return;

    localStorage.setItem("maxProblems", v);
    alert("限定問題数を保存しました");
  }

  /* ====== プリセット適用 ====== */
  function applyPreset() {
    const key = document.getElementById("presetSelect").value;
    if (!key) return;

    const p = presets[key];

    scoreItems = JSON.parse(JSON.stringify(p.items));
    localStorage.setItem("scoreItems", JSON.stringify(scoreItems));

    localStorage.setItem("currentRule", key);

    localStorage.setItem("winScore",  p.winScore);
    localStorage.setItem("winCount",  p.winCount);
    localStorage.setItem("loseWrong", p.loseWrong);

    alert("ルールプリセットを適用しました");
  }

  /* ====== 勝ち抜け・脱落設定保存 ====== */
  function saveWinLoseSettings() {
    const ws = Number(document.getElementById("winScore").value);
    const wc = Number(document.getElementById("winCount").value);
    const lw = Number(document.getElementById("loseWrong").value);

    if (ws > 0) localStorage.setItem("winScore", ws);
    if (wc > 0) localStorage.setItem("winCount", wc);
    if (lw > 0) localStorage.setItem("loseWrong", lw);

    alert("勝ち抜け・脱落設定を保存しました");
  }

  /* ====== プレイヤー編集（v4） ====== */
  function savePlayers() {
    const text = document.getElementById("playerEditor").value.trim();
    if (!text) return;

    const lines = text.split("\n");
    const newPlayers = [];

    for (const line of lines) {
      const parts = line.split(",");
      if (parts.length < 3) continue;

      const rank = Number(parts[0].trim());
      const pref = parts[1].trim();
      const name = parts[2].trim();

      newPlayers.push({
        rank,
        prefecture: pref,
        name,
        scores: {},
        status: "alive",
        freezeStop: 0
      });
    }

    players = newPlayers;
    localStorage.setItem("players", JSON.stringify(players));

    alert("プレイヤー情報を更新しました");
  }

  /* ====== Log 表示 ====== */
  function renderLog() {
    const logDiv = document.getElementById("log");
    logDiv.innerHTML = "";

    logs.slice(-300).forEach(line => {
      const div = document.createElement("div");
      div.className = "log-item";
      div.textContent = line;
      logDiv.appendChild(div);
    });
  }

  /* ====== 初期値をフォームに反映 ====== */
  function loadInitialValues() {
    document.getElementById("winScore").value  = winScore;
    document.getElementById("winCount").value  = winCount;
    document.getElementById("loseWrong").value = loseWrong;

    // プレイヤー編集欄に現在の players を反映
    const text = players
      .map(p => `${p.rank || ""},${p.prefecture || ""},${p.name}`)
      .join("\n");
    document.getElementById("playerEditor").value = text;
  }

  loadInitialValues();
  renderLog();

  /* ====== main.html からの log 更新を監視 ====== */
  window.addEventListener("storage", () => {
    logs = JSON.parse(localStorage.getItem("logs") || "[]");
    renderLog();
  });
</script>

</body>
</html>
