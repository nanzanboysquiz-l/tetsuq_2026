<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Score Main N2 v1</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f0f0f0;
    }

    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 10px 20px;
      border-bottom: 2px solid #ccc;
      font-size: 20px;
      font-weight: bold;
    }

    #problemCountDisplay {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    #players {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      padding: 20px;
    }

    .player {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      width: 120px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    .player.out { opacity: 0.4; background: #eee; }

    .rank-badge {
      font-size: 16px;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 6px;
    }

    .prefecture {
      font-size: 14px;
      color: #333;
    }

    .player-name {
      writing-mode: vertical-rl;
      text-orientation: upright;
      font-weight: 900;
      line-height: 1.1;
      height: 180px;
      width: 40px;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      transform-origin: center center;
    }

    .score-box {
      background: #fff;
      border: 1px solid #ccc;
      width: 60px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      color: #000;
    }

    .player-status {
      font-size: 14px;
      color: #333;
      text-align: center;
    }

    #footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #333;
      color: #fff;
      font-size: 14px;
      padding: 6px 10px;
      white-space: nowrap;
      overflow-x: auto;
    }
  </style>
</head>

<body>

<div id="header">
  <div>普通</div>
  <div id="problemCountDisplay">問題数: 0</div>
  <div>4号車</div>
</div>

<div id="players"></div>

<div id="footer"></div>

<script>
let players      = JSON.parse(localStorage.getItem("players")      || "[]");
let scoreItems   = JSON.parse(localStorage.getItem("scoreItems")   || "[]");
let logs         = JSON.parse(localStorage.getItem("logs")         || "[]");
let problemCount = Number(localStorage.getItem("problemCount")     || 0);
let maxProblems  = Number(localStorage.getItem("maxProblems")      || 0);
let finished     = false;
let history      = [];

let winScore  = Number(localStorage.getItem("winScore")  || 0);
let winCount  = Number(localStorage.getItem("winCount")  || 0);
let loseWrong = Number(localStorage.getItem("loseWrong") || 0);

let winners = JSON.parse(localStorage.getItem("winners") || "[]");
let winSettingMode = false;

function getPreset() {
  return localStorage.getItem("currentRule") || "";
}

function ordinal(n) {
  const s = ["th", "st", "nd", "rd"];
  const v = n % 100;
  return n + (s[(v - 20) % 10] || s[v] || s[0]);
}

function rankColor(rank) {
  if (rank === 1) return { bg: "#FFD700", fg: "#000" };
  if (rank === 2) return { bg: "#C0C0C0", fg: "#000" };
  if (rank === 3 || rank === 4) return { bg: "#CC0000", fg: "#FFF" };
  if (rank >= 5 && rank <= 10) return { bg: "#0066CC", fg: "#FFF" };
  return { bg: "#009900", fg: "#FFF" };
}

function adjustNameSize(nameDiv) {
  const maxHeight = 180;
  nameDiv.style.transform = "scaleY(1)";
  const actual = nameDiv.scrollHeight;

  if (actual > maxHeight) {
    const scale = (maxHeight / actual) * 0.85;
    nameDiv.style.transform = `scaleY(${scale})`;
  }
}

function calcTotal(player) {
  let total = 0;
  scoreItems.forEach(item => {
    const v = player.scores[item.name];
    const safe = Number.isFinite(v) ? v : 0;
    total += safe * item.weight;
  });
  return total;
}

function render() {
  const container = document.getElementById("players");
  container.innerHTML = "";

  players.forEach((p, idx) => {
    const div = document.createElement("div");
    div.className = "player";
    if (p.status === "out") div.classList.add("out");

    const rankDiv = document.createElement("div");
    rankDiv.className = "rank-badge";
    if (p.rank) {
      const c = rankColor(p.rank);
      rankDiv.style.background = c.bg;
      rankDiv.style.color = c.fg;
      rankDiv.textContent = ordinal(p.rank);
    }
    div.appendChild(rankDiv);

    const prefDiv = document.createElement("div");
    prefDiv.className = "prefecture";
    prefDiv.textContent = p.prefecture || "";
    div.appendChild(prefDiv);

    const nameDiv = document.createElement("div");
    nameDiv.className = "player-name";
    nameDiv.textContent = p.name;
    div.appendChild(nameDiv);
    requestAnimationFrame(() => adjustNameSize(nameDiv));

    const scoreBox = document.createElement("div");
    scoreBox.className = "score-box";
    scoreBox.textContent = calcTotal(p);
    div.appendChild(scoreBox);

    const statusDiv = document.createElement("div");
    statusDiv.className = "player-status";

    if (winners.includes(idx)) {
      statusDiv.textContent = `${winners.indexOf(idx) + 1}位`;
    } else if (p.status === "out") {
      statusDiv.textContent = "脱落";
    } else if (getPreset() === "freeze" && p.freezeStop > 0) {
      statusDiv.textContent = `Stop ${p.freezeStop}`;
    }

    const wrong = Number.isFinite(p.scores["誤答"]) ? p.scores["誤答"] : 0;
    if (wrong > 0) statusDiv.textContent += ` / 誤答${wrong}`;

    div.appendChild(statusDiv);
    container.appendChild(div);
  });

  document.getElementById("problemCountDisplay").textContent =
    `問題数: ${problemCount}`;
}
  /* ====== 設定情報（フッター） ====== */
function updateFooter() {
  const rule = getPreset() || "---";
  const text =
    `ルール: ${rule} ｜ 限定: ${maxProblems || "---"}問 ｜ ` +
    `勝ち抜け点: ${winScore} ｜ 勝ち抜け人数: ${winCount} ｜ 脱落誤答数: ${loseWrong}`;

  document.getElementById("footer").textContent = text;
}

/* ====== Freeze 減衰 ====== */
function applyFreezeDecay() {
  if (getPreset() !== "freeze") return;
  players.forEach(p => {
    if (p.freezeStop > 0) p.freezeStop--;
  });
}

/* ====== 勝ち抜け判定 ====== */
function checkWinner(playerIndex) {
  const p = players[playerIndex];
  const total = calcTotal(p);

  if (total >= winScore && !winners.includes(playerIndex)) {
    winners.push(playerIndex);
    localStorage.setItem("winners", JSON.stringify(winners));

    const now = new Date().toLocaleTimeString();
    logs.push(`${now} ${p.name} が勝ち抜け（${winners.length}位）`);
    localStorage.setItem("logs", JSON.stringify(logs));
  }

  if (winners.length >= winCount) {
    finished = true;
  }
}

/* ====== 脱落判定 ====== */
function checkLose(playerIndex) {
  const p = players[playerIndex];
  const wrong = p.scores["誤答"] || 0;

  if (wrong >= loseWrong && p.status !== "out") {
    p.status = "out";

    const now = new Date().toLocaleTimeString();
    logs.push(`${now} ${p.name} が脱落`);
    localStorage.setItem("logs", JSON.stringify(logs));
  }
}

/* ====== 勝ち抜け設定モード判定 ====== */
function checkWinSettingMode() {
  if (winners.length >= winCount) return;

  const alive = players.filter((p, i) =>
    p.status !== "out" && !winners.includes(i)
  ).length;

  if (maxProblems && problemCount >= maxProblems && winners.length < winCount)
    winSettingMode = true;

  if (alive === winCount - winners.length)
    winSettingMode = true;
}

/* ====== スコア処理 ====== */
function changeScore(playerIndex, itemName, delta) {
  if (finished || winSettingMode) return;

  const p = players[playerIndex];
  const preset = getPreset();

  if (preset === "freeze" && p.freezeStop > 0) return;

  const prevData = {
    type: "score",
    playerIndex,
    prevScores: JSON.parse(JSON.stringify(p.scores || {})),
    prevStatus: p.status,
    prevFreeze: p.freezeStop,
    prevWinners: [...winners],
    problemDelta: -1
  };
  history.push(prevData);

  if (typeof p.scores[itemName] !== "number") p.scores[itemName] = 0;
  p.scores[itemName] += delta;

  if (preset === "updown" && itemName === "誤答") {
    if (p.scores["誤答"] === 1) p.scores["正解"] = 0;
    if (p.scores["誤答"] === 2) p.status = "out";
  }

  if (preset === "freeze" && itemName === "誤答") {
    p.freezeStop = (p.scores["誤答"] || 0) + 1;
  }

  checkLose(playerIndex);
  checkWinner(playerIndex);

  problemCount++;
  applyFreezeDecay();
  render();
  updateFooter();
  checkWinSettingMode();

  const now = new Date().toLocaleTimeString();
  const seikai = p.scores["正解"] || 0;
  const gotou  = p.scores["誤答"] || 0;

  logs.push(`${now} ${p.name} ${itemName} +${delta} (${seikai}-${gotou})`);
  localStorage.setItem("logs", JSON.stringify(logs));

  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("problemCount", problemCount);
  localStorage.setItem("winners", JSON.stringify(winners));
}

/* ====== スルー ====== */
function noAnswer() {
  if (finished || winSettingMode) return;

  const prevData = {
    type: "noAnswer",
    prevFreezeAll: players.map(p => p.freezeStop),
    problemDelta: -1
  };
  history.push(prevData);

  problemCount++;
  applyFreezeDecay();
  render();
  updateFooter();
  checkWinSettingMode();

  const now = new Date().toLocaleTimeString();
  logs.push(`${now} スルー`);
  localStorage.setItem("logs", JSON.stringify(logs));

  localStorage.setItem("problemCount", problemCount);
}

/* ====== Undo ====== */
function undo() {
  if (finished || winSettingMode) return;

  const last = history.pop();
  if (!last) return;

  if (last.type === "score") {
    const p = players[last.playerIndex];
    p.scores = last.prevScores;
    p.status = last.prevStatus;
    p.freezeStop = last.prevFreeze;
    winners = last.prevWinners;
    problemCount += last.problemDelta;
  } else if (last.type === "noAnswer") {
    problemCount += last.problemDelta;
    players.forEach((p, i) => {
      p.freezeStop = last.prevFreezeAll[i];
    });
  }

  finished = false;

  render();
  updateFooter();
  checkWinSettingMode();

  const now = new Date().toLocaleTimeString();
  logs.push(`${now} Undo`);
  localStorage.setItem("logs", JSON.stringify(logs));

  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("problemCount", problemCount);
  localStorage.setItem("winners", JSON.stringify(winners));
}

/* ====== キーボード操作 ====== */
document.addEventListener("keydown", (e) => {
  const code = e.code;
  const isNumpad = code.startsWith("Numpad");

  if (winSettingMode) {
    if (!isNumpad) return;
    e.preventDefault();

    let index = null;
    if (code === "Numpad0") index = 9;
    else {
      const num = Number(code.replace("Numpad", ""));
      if (num >= 1 && num <= 9) index = num - 1;
    }

    if (index === null || index >= players.length) return;
    if (winners.includes(index)) return;

    winners.push(index);
    localStorage.setItem("winners", JSON.stringify(winners));

    if (winners.length >= winCount) {
      winSettingMode = false;
      finished = true;
    }

    render();
    updateFooter();
    checkWinSettingMode();
    return;
  }

  if (finished) return;

  if (isNumpad) {
    e.preventDefault();

    let index = null;
    if (code === "Numpad0") index = 9;
    else {
      const num = Number(code.replace("Numpad", ""));
      if (num >= 1 && num <= 9) index = num - 1;
    }

    if (index !== null && index < players.length) {
      const p = players[index];
      if (p.status !== "out" && !winners.includes(index) && p.freezeStop === 0) {
        if (e.ctrlKey) changeScore(index, "誤答", +1);
        else changeScore(index, "正解", +1);
      }
    }
    return;
  }

  if (code === "Insert") {
    e.preventDefault();
    noAnswer();
    return;
  }

  if (code === "Delete") {
    e.preventDefault();
    undo();
    return;
  }
});

/* ====== リセット ====== */
function resetAll() {
  const ok = window.confirm("全データをリセットします。よろしいですか？");
  if (!ok) return;

  players.forEach(p => {
    p.scores = {};
    p.status = "alive";
    p.freezeStop = 0;
  });

  history = [];
  logs = [];
  problemCount = 0;
  finished = false;
  winners = [];
  winSettingMode = false;

  localStorage.setItem("players", JSON.stringify(players));
  localStorage.setItem("problemCount", problemCount);
  localStorage.setItem("logs", JSON.stringify(logs));
  localStorage.setItem("winners", JSON.stringify(winners));

  render();
  updateFooter();
  checkWinSettingMode();

  window.dispatchEvent(new Event("storage"));
}

/* ====== localStorage 監視 ====== */
window.addEventListener("storage", () => {
  players      = JSON.parse(localStorage.getItem("players")      || "[]");
  scoreItems   = JSON.parse(localStorage.getItem("scoreItems")   || "[]");
  logs         = JSON.parse(localStorage.getItem("logs")         || "[]");
  problemCount = Number(localStorage.getItem("problemCount")     || 0);
  maxProblems  = Number(localStorage.getItem("maxProblems")      || 0);
  winScore     = Number(localStorage.getItem("winScore")         || 0);
  winCount     = Number(localStorage.getItem("winCount")         || 0);
  loseWrong    = Number(localStorage.getItem("loseWrong")        || 0);
  winners      = JSON.parse(localStorage.getItem("winners")      || "[]");

  finished = false;

  render();
  updateFooter();
  checkWinSettingMode();
});

/* ====== 初期描画 ====== */
render();
updateFooter();
checkWinSettingMode();
</script>

</body>
</html>
