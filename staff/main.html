<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Score Main N2 v10 Railway Style</title>

<style>
/* ====== 全体 ====== */
body {
  margin: 0;
  font-family: "Yu Gothic", "Hiragino Kaku Gothic ProN", sans-serif;
  background: #eef2f3;
}

/* ====== ヘッダー ====== */
#header {
  position: relative;
  text-align: center;
  padding: 20px 0 10px;
  border-bottom: 4px solid #f57c00;
}

#problemCountDisplay {
  font-size: 64px;
  font-weight: 900;
  letter-spacing: 6px;
}

.train-type, .car-number {
  position: absolute;
  top: 20px;
  background: #666;
  color: #fff;
  padding: 6px 14px;
  border-radius: 8px;
  font-size: 20px;
}
.train-type { left: 20px; }
.car-number { right: 20px; }

/* ====== プレイヤーエリア ====== */
#players {
  position: relative;
  background: #fff;
  padding: 40px 20px 160px;
  display: flex;
  justify-content: space-between;
}

/* ====== 駅（プレイヤー） ====== */
.player-card {
  position: relative;
  flex: 1;
  text-align: center;
}

/* ====== 駅名（縦書き） ====== */
.name-area {
  height: 160px;
  display: flex;
  justify-content: center;
  align-items: center;
}

.player-name {
  writing-mode: vertical-rl;
  text-orientation: upright;
  font-size: 32px;
  font-weight: 800;
  transform-origin: center center;
}

/* ====== オレンジ帯 ====== */
#global-score-band {
  position: absolute;
  top: 220px;
  left: 0;
  width: 100%;
  height: 36px;
  background: #f57c00;
  z-index: 1;
}

/* ====== スコア（帯中央） ====== */
.score-card {
  position: absolute;
  top: 220px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2;
}

.score-box {
  width: 48px;
  height: 30px;
  line-height: 30px;
  background: #fff;
  border: 2px solid #ccc;
  font-size: 20px;
  font-weight: bold;
}

/* ====== 状態（路線名風） ====== */
.status-card {
  margin-top: 120px;
  font-size: 14px;
  font-weight: 700;
  color: #222;
}

/* ====== フッター ====== */
#footer {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #000;
  color: #fff;
  font-size: 13px;
  padding: 6px 10px;
  white-space: nowrap;
}
</style>
</head>

<body>

<div id="header">
  <div class="train-type">普通</div>
  <div id="problemCountDisplay">第0問</div>
  <div class="car-number">4号車</div>
</div>

<div id="players">
  <div id="global-score-band"></div>
</div>

<div id="footer">
  Railway Style Score Board
</div>

<script>
/* ====== 元ロジック完全残置 ====== */
let players      = JSON.parse(localStorage.getItem("players") || "[]");
let scoreItems   = JSON.parse(localStorage.getItem("scoreItems") || "[]");
let logs         = JSON.parse(localStorage.getItem("logs") || "[]");
let problemCount = Number(localStorage.getItem("problemCount") || 0);
let maxProblems  = Number(localStorage.getItem("maxProblems") || 0);
let finished     = false;
let history      = [];

let winScore  = Number(localStorage.getItem("winScore") || 0);
let winCount  = Number(localStorage.getItem("winCount") || 0);
let loseWrong = Number(localStorage.getItem("loseWrong") || 0);

let winners = JSON.parse(localStorage.getItem("winners") || "[]");
let winSettingMode = false;

/* ====== 補助 ====== */
function getPreset() {
  return localStorage.getItem("currentRule") || "";
}

function adjustNameSize(nameDiv) {
  const maxHeight = 160;
  nameDiv.style.transform = "scaleY(1)";
  const actual = nameDiv.scrollHeight;
  if (actual > maxHeight) {
    nameDiv.style.transform = `scaleY(${maxHeight / actual})`;
  }
}

function calcTotal(player) {
  let total = 0;
  scoreItems.forEach(item => {
    const v = player.scores[item.name];
    total += (Number.isFinite(v) ? v : 0) * item.weight;
  });
  return total;
}

/* ====== UI生成（差し替え済み） ====== */
function createPlayerCard(p, idx) {
  const card = document.createElement("div");
  card.className = `player-card player-${idx}`;

  const nameArea = document.createElement("div");
  nameArea.className = "name-area";

  const nameDiv = document.createElement("div");
  nameDiv.className = "player-name";
  nameDiv.textContent = p.name;

  nameArea.appendChild(nameDiv);
  card.appendChild(nameArea);

  requestAnimationFrame(() => adjustNameSize(nameDiv));
  return card;
}

function createScoreCard(p, idx) {
  const card = document.createElement("div");
  card.className = `score-card player-${idx}`;

  const box = document.createElement("div");
  box.className = "score-box";
  box.textContent = calcTotal(p);

  card.appendChild(box);
  return card;
}

function createStatusCard(p, idx) {
  const card = document.createElement("div");
  card.className = `status-card player-${idx}`;

  let text = "";
  if (winners.includes(idx)) {
    text = `${winners.indexOf(idx) + 1}位 到着`;
  } else if (p.status === "out") {
    text = "通過不能";
  } else if (getPreset() === "freeze" && p.freezeStop > 0) {
    text = `Stop ${p.freezeStop}`;
  }

  const wrong = p.scores["誤答"] || 0;
  if (wrong > 0) text += ` / 誤答${wrong}`;

  card.textContent = text;
  return card;
}

/* ====== 描画 ====== */
function render() {
  const container = document.getElementById("players");
  container.innerHTML = '<div id="global-score-band"></div>';

  players.forEach((p, idx) => {
    container.appendChild(createPlayerCard(p, idx));
    container.appendChild(createScoreCard(p, idx));
    container.appendChild(createStatusCard(p, idx));
  });

  document.getElementById("problemCountDisplay").textContent =
    `第${problemCount}問`;
}

/* ====== 初期描画 ====== */
render();
</script>

</body>
</html>
